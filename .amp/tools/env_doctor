#!/bin/bash
# Amp Toolbox: Environment Doctor
# Validates environment setup and configuration

if [ "$TOOLBOX_ACTION" = "describe" ]; then
    cat <<EOF
name: env_doctor
description: Check that all required environment variables and dependencies are configured correctly. Run this when starting development, debugging connection issues, or onboarding. Reports missing/invalid configuration with fix suggestions.
check: string? Specific check to run: 'all', 'env', 'db', 'supabase', 'openai', 'deps'. Default: 'all'
EOF
    exit 0
fi

# Parse input
CHECK="all"

while IFS='=' read -r key value; do
    case "$key" in
        check) CHECK="$value" ;;
    esac
done

cd "$(dirname "$0")/../.." || exit 1

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0
WARNINGS=0

check_env_var() {
    local var_name="$1"
    local required="$2"
    local hint="$3"
    
    if [ -z "${!var_name}" ]; then
        if [ "$required" = "required" ]; then
            echo -e "${RED}‚ùå $var_name${NC} - Missing (required)"
            [ -n "$hint" ] && echo "   Hint: $hint"
            ((ERRORS++))
        else
            echo -e "${YELLOW}‚ö†Ô∏è  $var_name${NC} - Not set (optional)"
            [ -n "$hint" ] && echo "   Hint: $hint"
            ((WARNINGS++))
        fi
        return 1
    else
        # Check for placeholder values
        if [[ "${!var_name}" == *"your-"* ]] || [[ "${!var_name}" == *"xxx"* ]] || [[ "${!var_name}" == *"placeholder"* ]]; then
            echo -e "${YELLOW}‚ö†Ô∏è  $var_name${NC} - Appears to be a placeholder value"
            ((WARNINGS++))
            return 1
        fi
        echo -e "${GREEN}‚úÖ $var_name${NC} - Set"
        return 0
    fi
}

check_env() {
    echo "=== Environment Variables ==="
    echo ""
    
    # Load .env if exists
    if [ -f ".env" ]; then
        echo "üìÑ Loading .env file..."
        set -a
        source .env 2>/dev/null
        set +a
    elif [ -f ".env.local" ]; then
        echo "üìÑ Loading .env.local file..."
        set -a
        source .env.local 2>/dev/null
        set +a
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No .env or .env.local file found${NC}"
        echo "   Run: cp .env.example .env"
        ((WARNINGS++))
    fi
    echo ""
    
    # Check required vars
    echo "Required variables:"
    check_env_var "DATABASE_URL" "required" "PostgreSQL connection string"
    check_env_var "NEXT_PUBLIC_SUPABASE_URL" "required" "Get from Supabase dashboard"
    check_env_var "NEXT_PUBLIC_SUPABASE_ANON_KEY" "required" "Get from Supabase dashboard"
    check_env_var "OPENAI_API_KEY" "required" "Get from platform.openai.com"
    
    echo ""
    echo "Optional variables:"
    check_env_var "SUPABASE_SERVICE_ROLE_KEY" "optional" "For server-side Supabase admin access"
}

check_deps() {
    echo "=== Dependencies ==="
    echo ""
    
    # Check Node.js
    if command -v node &> /dev/null; then
        NODE_VERSION=$(node -v)
        echo -e "${GREEN}‚úÖ Node.js${NC} - $NODE_VERSION"
    else
        echo -e "${RED}‚ùå Node.js${NC} - Not installed"
        ((ERRORS++))
    fi
    
    # Check pnpm
    if command -v pnpm &> /dev/null; then
        PNPM_VERSION=$(pnpm -v)
        echo -e "${GREEN}‚úÖ pnpm${NC} - $PNPM_VERSION"
    else
        echo -e "${RED}‚ùå pnpm${NC} - Not installed"
        echo "   Run: npm install -g pnpm"
        ((ERRORS++))
    fi
    
    # Check if node_modules exists
    if [ -d "node_modules" ]; then
        echo -e "${GREEN}‚úÖ node_modules${NC} - Installed"
    else
        echo -e "${RED}‚ùå node_modules${NC} - Not installed"
        echo "   Run: pnpm install"
        ((ERRORS++))
    fi
    
    # Check for TypeScript
    if [ -f "node_modules/.bin/tsc" ]; then
        TSC_VERSION=$(node_modules/.bin/tsc --version)
        echo -e "${GREEN}‚úÖ TypeScript${NC} - $TSC_VERSION"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  TypeScript${NC} - Not found in node_modules"
        ((WARNINGS++))
    fi
}

check_db() {
    echo "=== Database Connection ==="
    echo ""
    
    # Load env
    if [ -f ".env" ]; then
        set -a; source .env 2>/dev/null; set +a
    elif [ -f ".env.local" ]; then
        set -a; source .env.local 2>/dev/null; set +a
    fi
    
    if [ -z "$DATABASE_URL" ]; then
        echo -e "${RED}‚ùå DATABASE_URL not set${NC}"
        ((ERRORS++))
        return
    fi
    
    # Try to connect using drizzle-kit
    echo "Testing database connection..."
    if pnpm drizzle-kit push --dry-run &> /dev/null; then
        echo -e "${GREEN}‚úÖ Database connection successful${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Could not verify database connection${NC}"
        echo "   This may be normal if database isn't running"
        ((WARNINGS++))
    fi
    
    # Check for migrations
    if [ -d "src/lib/db/migrations" ]; then
        MIGRATION_COUNT=$(ls -1 src/lib/db/migrations/*.sql 2>/dev/null | wc -l)
        echo -e "${GREEN}‚úÖ Migrations directory${NC} - $MIGRATION_COUNT migration(s)"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No migrations directory${NC}"
        ((WARNINGS++))
    fi
}

check_supabase() {
    echo "=== Supabase Configuration ==="
    echo ""
    
    # Load env
    if [ -f ".env" ]; then
        set -a; source .env 2>/dev/null; set +a
    elif [ -f ".env.local" ]; then
        set -a; source .env.local 2>/dev/null; set +a
    fi
    
    if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then
        echo -e "${RED}‚ùå NEXT_PUBLIC_SUPABASE_URL not set${NC}"
        ((ERRORS++))
        return
    fi
    
    # Validate URL format
    if [[ "$NEXT_PUBLIC_SUPABASE_URL" =~ ^https://.*\.supabase\.co$ ]]; then
        echo -e "${GREEN}‚úÖ Supabase URL format valid${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Supabase URL may be invalid${NC}"
        echo "   Expected: https://<project>.supabase.co"
        ((WARNINGS++))
    fi
    
    # Check for client files
    if [ -f "src/lib/supabase/client.ts" ]; then
        echo -e "${GREEN}‚úÖ Supabase client configured${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Supabase client not found${NC}"
        ((WARNINGS++))
    fi
}

check_openai() {
    echo "=== OpenAI Configuration ==="
    echo ""
    
    # Load env
    if [ -f ".env" ]; then
        set -a; source .env 2>/dev/null; set +a
    elif [ -f ".env.local" ]; then
        set -a; source .env.local 2>/dev/null; set +a
    fi
    
    if [ -z "$OPENAI_API_KEY" ]; then
        echo -e "${RED}‚ùå OPENAI_API_KEY not set${NC}"
        ((ERRORS++))
        return
    fi
    
    # Validate key format (starts with sk-)
    if [[ "$OPENAI_API_KEY" =~ ^sk- ]]; then
        echo -e "${GREEN}‚úÖ OpenAI API key format valid${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  OpenAI API key format unexpected${NC}"
        echo "   Expected: sk-..."
        ((WARNINGS++))
    fi
    
    # Check for AI lib files
    if [ -d "src/lib/ai" ]; then
        echo -e "${GREEN}‚úÖ AI library configured${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  AI library not found${NC}"
        ((WARNINGS++))
    fi
}

# Run checks based on input
case "$CHECK" in
    all)
        check_deps
        echo ""
        check_env
        echo ""
        check_db
        echo ""
        check_supabase
        echo ""
        check_openai
        ;;
    env)
        check_env
        ;;
    deps)
        check_deps
        ;;
    db)
        check_db
        ;;
    supabase)
        check_supabase
        ;;
    openai)
        check_openai
        ;;
    *)
        echo "Unknown check: $CHECK"
        echo "Available: all, env, deps, db, supabase, openai"
        exit 1
        ;;
esac

# Summary
echo ""
echo "=== Summary ==="
if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo -e "${GREEN}‚úÖ All checks passed!${NC}"
elif [ $ERRORS -eq 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  $WARNINGS warning(s), 0 errors${NC}"
else
    echo -e "${RED}‚ùå $ERRORS error(s), $WARNINGS warning(s)${NC}"
    echo ""
    echo "Fix the errors above before proceeding."
    exit 1
fi
